name: Deploy prebuilt Docker image to EC2

on:
  workflow_dispatch:   # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set env version
      run: echo "RELEASE_VERSION=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

    # ===============================
    # âœ… EC2ë¡œ SSH ì ‘ì†í•´ì„œ ë°°í¬ë§Œ ìˆ˜í–‰
    # ===============================
    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "ğŸ› ï¸ Pulling latest image from Docker Hub..."
          docker pull hands7/miniproject3-backend:0.4
          docker pull hands7/miniproject3-ai:0.3
          docker pull hands7/miniproject3_frontend:0.5
          docker pull mariadb:10.11.8
          
          echo "ğŸ§¹ Stopping old containers..."
          docker compose -f /work/myproject/docker-compose.yml down

          echo "ğŸš€ Starting new containers..."
          docker compose -f /work/myproject/docker-compose.yml up -d

          echo "âœ… Deployment complete!!"
