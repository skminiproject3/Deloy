name: Deploy prebuilt Docker image to EC2

on:
  workflow_dispatch:   # 수동 실행도 가능
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set env version
      run: echo "RELEASE_VERSION=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

    # ===============================
    # EC2로 SSH 접속해서 배포 수행
    # ===============================
    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "=================================="
          echo " Pulling latest images from Docker Hub..."
          echo "=================================="
          docker pull hands7/miniproject3-backend:0.4
          docker pull hands7/miniproject3-ai:0.3
          docker pull hands7/miniproject3_frontend:0.5
          docker pull mariadb:10.11.8

          echo "=================================="
          echo " Stopping old containers..."
          echo "=================================="
          docker-compose -f /work/myproject/docker-compose.yml down

          echo "=================================="
          echo " Starting new containers..."
          echo "=================================="
          docker-compose -f /work/myproject/docker-compose.yml up -d

          echo "=================================="
          echo " Deployment complete!"
          echo "=================================="
